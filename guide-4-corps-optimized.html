<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Diagnostic énergétique complet des 4 corps - Application professionnelle de bilan vibratoire">
    <meta name="keywords" content="diagnostic énergétique, 4 corps, numérologie, astrologie, bilan vibratoire">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Bilan Expert - Guide des 4 Corps | Diagnostic Énergétique</title>

    <!-- Preconnect pour optimiser le chargement -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Resources -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           VARIABLES & BASE
        ======================================== */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: rgba(30, 41, 59, 0.7);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-blue: #3b82f6;
            --transition: 0.3s ease;
            --shadow-sm: 0 4px 20px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0, transparent 50%),
                radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.1) 0, transparent 50%);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* ========================================
           COMPOSANTS RÉUTILISABLES
        ======================================== */
        .glass {
            background: var(--bg-secondary);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all var(--transition);
            will-change: transform;
        }

        .glass:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* ========================================
           ANIMATIONS
        ======================================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .fade-in {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .slide-in {
            animation: slideInRight 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* ========================================
           FORMULAIRES
        ======================================== */
        .input-field {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all var(--transition);
            outline: none;
        }

        .input-field:focus {
            border-color: var(--accent-blue);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .input-field.error {
            border-color: #ef4444;
            animation: shake 0.3s;
        }

        .input-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
        }

        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 6px;
            display: none;
            animation: fadeInUp 0.3s;
        }

        .error-message.show {
            display: block;
        }

        /* ========================================
           CHECKBOXES PERSONNALISÉES
        ======================================== */
        .checkbox-wrapper {
            position: relative;
            margin-bottom: 8px;
        }

        .checkbox-input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            padding: 16px 18px;
            background: rgba(255, 255, 255, 0.02);
            border: 2px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .custom-checkbox::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .custom-checkbox:hover::before {
            left: 100%;
        }

        .checkbox-input:checked + .custom-checkbox {
            background: rgba(59, 130, 246, 0.15);
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
            transform: scale(1.02);
        }

        .check-indicator {
            width: 24px;
            height: 24px;
            border: 2.5px solid #64748b;
            border-radius: 50%;
            margin-right: 14px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .checkbox-input:checked + .custom-checkbox .check-indicator {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            border-color: #3b82f6;
            transform: rotate(360deg);
        }

        .check-indicator::after {
            content: '✓';
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .checkbox-input:checked + .custom-checkbox .check-indicator::after {
            opacity: 1;
            transform: scale(1);
        }

        /* ========================================
           BARRES DE PROGRESSION
        ======================================== */
        .bar-container {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 100px;
            height: 14px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .bar-fill {
            height: 100%;
            border-radius: 100px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            will-change: width;
        }

        .bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Couleurs des éléments */
        .bg-fire { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .bg-water { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-earth { background: linear-gradient(135deg, #84cc16, #65a30d); }
        .bg-air { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .bg-lightning { background: linear-gradient(135deg, #fbbf24, #f59e0b); }

        /* ========================================
           BOUTONS
        ======================================== */
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: #fff;
            font-weight: 700;
            padding: 18px 24px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            transition: all var(--transition);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            position: relative;
            overflow: hidden;
            font-size: 15px;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(71, 85, 105, 0.4);
            color: #fff;
            font-weight: 600;
            padding: 14px 28px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all var(--transition);
        }

        .btn-secondary:hover {
            background: rgba(71, 85, 105, 0.6);
            transform: translateY(-2px);
        }

        /* ========================================
           TOOLTIP
        ======================================== */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            background: rgba(15, 23, 42, 0.95);
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity var(--transition);
            font-size: 12px;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* ========================================
           INDICATEURS DE PROGRESSION
        ======================================== */
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-bottom: 40px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all var(--transition);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .step.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            transition: all var(--transition);
        }

        .step.completed + .step .step-line {
            background: #10b981;
        }

        /* ========================================
           TOASTS
        ======================================== */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            transition: all var(--transition);
            z-index: 1000;
            max-width: 350px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success { border-left: 4px solid #10b981; }
        .toast.error { border-left: 4px solid #ef4444; }
        .toast.info { border-left: 4px solid #3b82f6; }

        /* ========================================
           SKELETON LOADER
        ======================================== */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 25%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* ========================================
           PRINT STYLES
        ======================================== */
        @media print {
            body {
                background: #fff;
                color: #000;
            }
            .glass {
                background: #fff;
                border: 1px solid #ddd;
                box-shadow: none;
                color: #000;
            }
            .no-print {
                display: none !important;
            }
            .text-white {
                color: #000 !important;
            }
            .text-slate-300,
            .text-slate-400 {
                color: #333 !important;
            }
            .bar-fill {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (max-width: 768px) {
            .progress-steps {
                gap: 8px;
            }
            .step-circle {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            .step-line {
                width: 30px;
            }
            .toast {
                right: 20px;
                left: 20px;
                bottom: 20px;
            }
        }

        /* ========================================
           UTILITAIRES
        ======================================== */
        .hidden {
            display: none !important;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        *:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Auto-save Indicator -->
    <div id="auto-save-indicator" class="auto-save-indicator" role="status" aria-live="polite">
        <i class="fa-solid fa-check-circle mr-2"></i>Sauvegardé
    </div>

    <!-- Toast Container -->
    <div id="toast-container" role="region" aria-live="polite" aria-atomic="true"></div>

    <!-- Progress Indicator -->
    <nav class="progress-steps no-print fade-in" style="animation-delay: 0.1s" aria-label="Progression du diagnostic">
        <div class="step active" id="step-indicator-1">
            <div class="step-circle" aria-current="step">1</div>
            <span class="hidden md:inline text-sm text-slate-400">Identité</span>
        </div>
        <div class="step-line" aria-hidden="true"></div>
        <div class="step" id="step-indicator-2">
            <div class="step-circle">2</div>
            <span class="hidden md:inline text-sm text-slate-400">Analyse</span>
        </div>
        <div class="step-line" aria-hidden="true"></div>
        <div class="step" id="step-indicator-3">
            <div class="step-circle">3</div>
            <span class="hidden md:inline text-sm text-slate-400">Résultat</span>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto">

        <!-- EN-TÊTE -->
        <header class="text-center mb-12 fade-in no-print" style="animation-delay: 0.2s">
            <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight text-white mb-3">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">
                    Guide des 4 Corps
                </span>
            </h1>
            <p class="text-slate-400 uppercase tracking-widest text-sm font-semibold">
                Diagnostic Énergétique Complet
            </p>
            <div class="mt-6 flex justify-center gap-4 text-xs text-slate-500">
                <span><i class="fa-solid fa-shield-halved mr-1" aria-hidden="true"></i>100% Confidentiel</span>
                <span><i class="fa-solid fa-clock mr-1" aria-hidden="true"></i>5 minutes</span>
                <span><i class="fa-solid fa-file-export mr-1" aria-hidden="true"></i>Export JSON</span>
            </div>
        </header>

        <!-- ÉTAPE 1 : IDENTITÉ -->
        <section id="step-identity" class="glass rounded-3xl p-8 md:p-12 fade-in max-w-xl mx-auto" style="animation-delay: 0.3s">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                <i class="fa-regular fa-id-card text-blue-400" aria-hidden="true"></i>
                Identité Vibratoire
            </h2>
            
            <form id="identity-form" novalidate>
                <div class="space-y-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="prenom" class="input-label">
                                Prénom <span class="text-red-400" aria-label="requis">*</span>
                            </label>
                            <input 
                                type="text" 
                                id="prenom" 
                                name="prenom"
                                class="input-field" 
                                placeholder="Votre prénom" 
                                required 
                                aria-required="true" 
                                autocomplete="given-name"
                                aria-describedby="error-prenom"
                            >
                            <p class="error-message" id="error-prenom" role="alert">Le prénom est requis</p>
                        </div>
                        <div>
                            <label for="nom" class="input-label">Nom de Famille</label>
                            <input 
                                type="text" 
                                id="nom" 
                                name="nom"
                                class="input-field" 
                                placeholder="Votre nom" 
                                autocomplete="family-name"
                            >
                        </div>
                    </div>
                    
                    <div>
                        <label for="naissance" class="input-label">
                            Date de Naissance <span class="text-red-400" aria-label="requis">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="naissance" 
                            name="naissance"
                            class="input-field" 
                            required 
                            aria-required="true" 
                            min="1900-01-01"
                            max="2024-12-31"
                            autocomplete="bday"
                            aria-describedby="error-naissance"
                        >
                        <p class="error-message" id="error-naissance" role="alert">Une date de naissance valide est requise</p>
                    </div>
                    
                    <div>
                        <label for="lieu" class="input-label">Lieu de Naissance</label>
                        <input 
                            type="text" 
                            id="lieu" 
                            name="lieu"
                            class="input-field" 
                            placeholder="Ville, Pays" 
                            autocomplete="address-level2"
                        >
                    </div>
                    
                    <button type="submit" class="btn-primary mt-6" aria-label="Lancer l'analyse énergétique">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2" aria-hidden="true"></i>
                        LANCER L'ANALYSE
                    </button>
                    
                    <div class="text-center mt-4">
                        <button 
                            type="button" 
                            id="load-session-btn"
                            class="text-sm text-slate-400 hover:text-blue-400 transition-colors underline"
                        >
                            <i class="fa-solid fa-clock-rotate-left mr-1" aria-hidden="true"></i>
                            Reprendre une session précédente
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- ÉTAPE 2 : QUESTIONNAIRE -->
        <section id="step-quiz" class="hidden">
            <div class="glass rounded-3xl p-6 md:p-10 fade-in">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-bold text-white mb-2">Analyse des 4 Corps</h2>
                    <p class="text-slate-400">Cochez ce qui correspond à votre ressenti profond.</p>
                    <div class="mt-4 inline-flex items-center gap-2 bg-blue-500/10 text-blue-300 px-4 py-2 rounded-full text-sm">
                        <i class="fa-solid fa-info-circle" aria-hidden="true"></i>
                        <span id="question-counter" role="status" aria-live="polite">0 réponse sélectionnée</span>
                    </div>
                </div>

                <form id="guide-form" class="space-y-10"></form>

                <div class="flex gap-4 flex-col md:flex-row mt-8">
                    <button type="button" id="back-btn" class="btn-secondary">
                        <i class="fa-solid fa-arrow-left mr-2" aria-hidden="true"></i>
                        Retour
                    </button>
                    <button type="button" id="submit-btn" class="btn-primary flex-1">
                        <i class="fa-solid fa-chart-line mr-2" aria-hidden="true"></i>
                        GÉNÉRER LE RAPPORT COMPLET
                    </button>
                </div>
            </div>
        </section>

        <!-- ÉTAPE 3 : RÉSULTAT -->
        <section id="step-result" class="hidden pb-24">
            
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 border-b border-white/10 pb-6 fade-in">
                <div>
                    <p class="text-slate-400 text-xs uppercase tracking-widest mb-1">Dossier Énergétique</p>
                    <h2 id="res-name-full" class="text-3xl md:text-4xl font-bold text-white capitalize mb-1"></h2>
                    <p id="res-lieu" class="text-sm text-slate-400"></p>
                </div>
                <div class="mt-4 md:mt-0 flex gap-6 text-right">
                    <div>
                        <span class="block text-xs text-slate-500 uppercase tracking-wider mb-1">Astrologie</span>
                        <span id="res-astro" class="text-white font-bold text-lg"></span>
                    </div>
                    <div class="border-l border-white/20 pl-6">
                        <span class="block text-xs text-slate-500 uppercase tracking-wider mb-1">Chemin de Vie</span>
                        <span id="res-numero" class="text-white font-bold text-lg"></span>
                    </div>
                </div>
            </div>

            <!-- Carte Numérologie Avancée -->
            <div id="numero-card" class="mb-8 glass p-6 rounded-2xl border-l-4 border-indigo-500 bg-indigo-500/5 slide-in" style="animation-delay: 0.1s">
                <div class="flex items-start gap-4">
                    <div class="text-indigo-400 text-3xl" aria-hidden="true">
                        <i class="fa-solid fa-compass"></i>
                    </div>
                    <div>
                        <h3 class="text-indigo-300 font-bold uppercase tracking-widest text-sm mb-2">
                            Boussole Numérologique
                        </h3>
                        <p id="numero-text" class="text-slate-200 text-sm leading-relaxed"></p>
                        <div id="numero-guide-tag" class="mt-3 inline-block px-3 py-1 rounded-full text-xs font-bold bg-indigo-500/20 text-indigo-200 border border-indigo-500/30"></div>
                    </div>
                </div>
            </div>

            <div id="saint-card" class="hidden mb-8 glass p-6 rounded-2xl border-l-4 border-yellow-400 bg-yellow-400/5 relative overflow-hidden slide-in" style="animation-delay: 0.2s">
                <div class="absolute right-0 top-0 text-9xl text-yellow-400/5" aria-hidden="true">
                    <i class="fa-solid fa-bolt"></i>
                </div>
                <div class="relative z-10">
                    <h3 class="text-yellow-400 font-bold uppercase tracking-widest text-sm mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-bolt" aria-hidden="true"></i>
                        Héritage Foudre Détecté
                    </h3>
                    <p class="text-slate-300 text-sm leading-relaxed">
                        Le prénom <strong><span id="saint-name" class="text-white capitalize"></span></strong> active une capacité innée de magnétisme électrique. C'est un canal naturel hérité des Saints ou Archanges, permettant de conduire la lumière fulgurante.
                    </p>
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                
                <!-- Colonne Gauche : Répartition et Prescriptions -->
                <div class="md:col-span-1 space-y-6">
                    <div class="glass p-6 rounded-2xl fade-in">
                        <h3 class="text-white font-bold mb-5 text-sm uppercase tracking-wide flex items-center gap-2">
                            <i class="fa-solid fa-chart-pie text-blue-400" aria-hidden="true"></i>
                            Répartition Élémentaire
                        </h3>
                        <div class="space-y-4" id="bars-container"></div>
                    </div>

                    <div class="glass p-6 rounded-2xl fade-in" style="animation-delay: 0.1s">
                        <h3 class="text-white font-bold mb-5 text-sm uppercase tracking-wide flex items-center gap-2">
                            <i class="fa-solid fa-mortar-pestle text-purple-400" aria-hidden="true"></i>
                            Prescriptions
                        </h3>
                        <ul class="space-y-4 text-sm">
                            <li class="flex items-start gap-3 p-3 bg-white/5 rounded-lg">
                                <span class="text-slate-400 text-lg" aria-hidden="true">
                                    <i class="fa-regular fa-gem"></i>
                                </span>
                                <div>
                                    <span class="text-slate-400 text-xs uppercase block mb-1">Pierre</span>
                                    <span id="pres-stone" class="text-white font-semibold"></span>
                                </div>
                            </li>
                            <li class="flex items-start gap-3 p-3 bg-white/5 rounded-lg">
                                <span class="text-slate-400 text-lg" aria-hidden="true">
                                    <i class="fa-solid fa-spray-can-sparkles"></i>
                                </span>
                                <div>
                                    <span class="text-slate-400 text-xs uppercase block mb-1">Huile Essentielle</span>
                                    <span id="pres-oil" class="text-white font-semibold"></span>
                                </div>
                            </li>
                            <li class="flex items-start gap-3 p-3 bg-white/5 rounded-lg">
                                <span class="text-slate-400 text-lg" aria-hidden="true">
                                    <i class="fa-solid fa-spa"></i>
                                </span>
                                <div>
                                    <span class="text-slate-400 text-xs uppercase block mb-1">Rituel Recommandé</span>
                                    <span id="pres-ritual" class="text-white font-semibold"></span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Colonne Droite : Profil et Détails -->
                <div class="md:col-span-2 space-y-6">
                    <div class="glass p-8 rounded-3xl border-t-4 fade-in" id="main-card" style="animation-delay: 0.2s">
                        <span class="bg-white/10 text-white px-3 py-1 rounded-full text-xs font-bold uppercase mb-4 inline-block">
                            Profil Dominant (Ressenti)
                        </span>
                        <h2 id="guide-title" class="text-3xl md:text-4xl font-black text-white mb-3"></h2>
                        <p id="guide-desc" class="text-lg text-slate-300 leading-relaxed mb-6"></p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-black/20 p-5 rounded-xl border border-emerald-500/20">
                                <h4 class="text-emerald-400 font-bold text-xs uppercase mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-wand-magic-sparkles" aria-hidden="true"></i>
                                    Super-Pouvoir
                                </h4>
                                <p id="guide-power" class="text-sm text-slate-300"></p>
                            </div>
                            <div class="bg-black/20 p-5 rounded-xl border border-red-500/20">
                                <h4 class="text-red-400 font-bold text-xs uppercase mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i>
                                    Point de Vigilance
                                </h4>
                                <p id="guide-warning" class="text-sm text-slate-300"></p>
                            </div>
                        </div>
                    </div>

                    <div class="glass p-8 rounded-3xl fade-in" style="animation-delay: 0.3s">
                        <h3 class="text-white font-bold mb-6 text-lg flex items-center gap-2">
                            <i class="fa-solid fa-microscope text-blue-400" aria-hidden="true"></i>
                            Analyse Détaillée par Corps
                        </h3>
                        <div class="space-y-5" id="details-container"></div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="mt-12 text-center no-print space-x-4 fade-in" style="animation-delay: 0.4s">
                <button id="print-btn" class="btn-secondary inline-flex items-center">
                    <i class="fa-solid fa-print mr-2" aria-hidden="true"></i>
                    Imprimer
                </button>
                <button id="share-btn" class="btn-secondary inline-flex items-center">
                    <i class="fa-solid fa-share-nodes mr-2" aria-hidden="true"></i>
                    Partager
                </button>
                <button id="download-btn" class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg hover:shadow-emerald-500/30 inline-flex items-center">
                    <i class="fa-solid fa-download mr-2" aria-hidden="true"></i>
                    Télécharger pour Gemini
                </button>
            </div>
            <div class="text-center mt-6 no-print">
                <button id="reset-btn" class="text-slate-500 hover:text-white underline text-sm transition-colors">
                    <i class="fa-solid fa-rotate-right mr-1" aria-hidden="true"></i>
                    Nouveau diagnostic
                </button>
            </div>
        </section>
    </div>

    <script>
        // ========================================
        // CONFIGURATION & CONSTANTES
        // ========================================
        const CONFIG = {
            storageKey: 'guide4corps_data',
            timestampKey: 'guide4corps_timestamp',
            minAnswers: 5,
            autoSaveDelay: 1000, // 1 seconde
            saints: [
                "marie", "jean", "gabriel", "michel", "raphael", 
                "pierre", "paul", "jacques", "anne", "joseph", 
                "emmanuel", "christophe", "daniel", "david", "samuel"
            ]
        };

        const NUMERO_DEFINITIONS = {
            fire: { 
                text: "Vibration d'action, de protection et de courage. Vous êtes le pionnier, le leader.", 
                guide: "Guide de Feu" 
            },
            water: { 
                text: "Vibration d'empathie, de soin et de compassion. Vous êtes le soignant, le soutien.", 
                guide: "Guide d'Eau" 
            },
            earth: { 
                text: "Vibration d'enracinement, de mémoire et de lignée. Vous êtes le bâtisseur, le gardien.", 
                guide: "Guide de Terre" 
            },
            air: { 
                text: "Vibration de vision, d'intuition et de multidimensionnalité. Vous êtes le messager, le canal.", 
                guide: "Guide d'Air" 
            },
            lightning: { 
                text: "Vibration de transmutation, de fréquence et d'accélération. Vous êtes le transformateur.", 
                guide: "Guide de Foudre" 
            }
        };

        const PROFILES = {
            fire: {
                title: "Le Guerrier Protecteur",
                desc: "Aura bouclier thermique. Énergie Yang, directive. Nettoie et sécurise l'espace énergétique avec une force implacable.",
                power: "Nettoyage immédiat et protection fulgurante des espaces et des êtres.",
                warning: "Épuisement intense dû au mode combat permanent. Besoin de repos profond.",
                details: {
                    emo: "Transforme instantanément la peur en colère d'action. Réaction défensive immédiate face aux injustices.",
                    phy: "Corps qui chauffe rapidement. Besoin fréquent de se refroidir. Métabolisme élevé.",
                    men: "Radar à danger permanent et ultra-sensible. Détecte les menaces avant qu'elles ne se manifestent.",
                    spi: "Gardien du Seuil entre les mondes. Protecteur des passages sacrés."
                },
                pres: { 
                    stone: "Grenat / Obsidienne noire", 
                    oil: "Cannelle / Gingembre", 
                    ritual: "Bougie de protection rouge. Visualisation du bouclier de feu." 
                },
                color: "border-red-500 shadow-red-500/20"
            },
            water: {
                title: "Le Guérisseur Émotionnel",
                desc: "Aura perméable et fluide. Énergie Yin, réceptive. Ressent profondément, filtre et apaise les blessures émotionnelles.",
                power: "Transmutation alchimique de la douleur par le cœur. Guérison émotionnelle profonde.",
                warning: "Saturation émotionnelle (Syndrome de l'éponge). Nécessité de se vider régulièrement.",
                details: {
                    emo: "Empathie totale et inconditionnelle. Ressent les émotions des autres comme les siennes.",
                    phy: "Besoin vital d'eau. Pleurs libérateurs fréquents. Purification par les larmes.",
                    men: "Pensée intuitive et cyclique, comme les marées. Navigation émotionnelle naturelle.",
                    spi: "Canal de la Mère Divine. Amour inconditionnel et compassion universelle."
                },
                pres: { 
                    stone: "Aigue-Marine / Calcite bleue", 
                    oil: "Ylang-Ylang / Camomille romaine", 
                    ritual: "Bain au sel d'Epsom avec intention de purification. Méditation lunaire." 
                },
                color: "border-blue-500 shadow-blue-500/20"
            },
            earth: {
                title: "Le Gardien des Ancêtres",
                desc: "Aura forteresse et enracinée. Énergie dense et stable. Ancre, bâtit et mémorise les lignées ancestrales.",
                power: "Stabilité absolue et connexion profonde aux racines familiales et terrestres.",
                warning: "Lourdeur énergétique. Risque de rester coincé dans le passé et les mémoires.",
                details: {
                    emo: "Stable, loyal et fiable. Porte consciemment ou inconsciemment le poids familial.",
                    phy: "Sensations intenses dans les jambes et les pieds. Ancrage tellurique puissant.",
                    men: "Mémoire prodigieuse des lieux et des générations. Gardien des histoires familiales.",
                    spi: "Pilier de Lumière tellurique. Pont entre la Terre-Mère et les générations."
                },
                pres: { 
                    stone: "Tourmaline Noire / Jaspe rouge", 
                    oil: "Cèdre / Vétiver", 
                    ritual: "Marche consciente pieds nus. Ancrage dans la nature. Contact avec les arbres." 
                },
                color: "border-green-500 shadow-green-500/20"
            },
            air: {
                title: "Le Voyageur des Dimensions",
                desc: "Aura vaporeuse et multidimensionnelle. Énergie rapide et légère. Voyage entre les plans, voit et informe.",
                power: "Vision à distance et accès direct aux archives akashiques. Télépathie naturelle.",
                warning: "Déconnexion du plan physique. Difficulté à rester ancré dans le présent.",
                details: {
                    emo: "Détaché, observateur neutre. Vit les émotions avec recul et perspective.",
                    phy: "Sensation constante de flotter. Maladresses physiques. Corps léger, esprit ailleurs.",
                    men: "Idées fulgurantes et connexions non-linéaires. Télépathie et prémonitions fréquentes.",
                    spi: "Messager entre Ciel et Terre. Porteur d'informations des plans supérieurs."
                },
                pres: { 
                    stone: "Lapis Lazuli / Célestine", 
                    oil: "Menthe Poivrée / Eucalyptus", 
                    ritual: "Fumigation avec sauge blanche. Écriture automatique et channeling." 
                },
                color: "border-purple-500 shadow-purple-500/20"
            },
            lightning: {
                title: "Le Transformateur Quantique",
                desc: "Aura électrique et magnétique. Énergie fulgurante et imprévisible. Réveille, choque et initie les transformations.",
                power: "Guérison quantique instantanée et déblocage énergétique puissant. Catalyseur de changements.",
                warning: "Court-circuit nerveux et surcharge du système. Hypersensibilité électrique.",
                details: {
                    emo: "Réactions explosives mais très brèves. Intensité émotionnelle fulgurante puis libération rapide.",
                    phy: "Système nerveux ultra-sensible. Picotements constants. Sensibilité aux champs électromagnétiques.",
                    men: "Intelligence foudroyante et arborescente. Connexions instantanées entre concepts éloignés.",
                    spi: "Éveilleur de conscience. Provoque les sauts quantiques et les révélations soudaines."
                },
                pres: { 
                    stone: "Améthyste / Fluorite violette", 
                    oil: "Lavande / Néroli", 
                    ritual: "Earthing intense (contact terre). Méditation de décharge énergétique." 
                },
                color: "border-yellow-500 shadow-yellow-500/20"
            }
        };

        const QUESTIONS = [
            {
                title: "1. Corps Émotionnel",
                icon: "fa-heart",
                color: "blue",
                tooltip: "Comment vous ressentez et gérez les émotions",
                items: [
                    { element: "fire", label: "<strong>Protecteur :</strong> Je monte vite en adrénaline pour défendre." },
                    { element: "water", label: "<strong>Éponge :</strong> Je pleure facilement devant la souffrance." },
                    { element: "earth", label: "<strong>Ancien :</strong> Je suis attiré par les rituels et l'histoire." },
                    { element: "air", label: "<strong>Visionnaire :</strong> Je vois le futur en flash ou en rêve." },
                    { element: "lightning", label: "<strong>Activateur :</strong> Les gens sont \"secoués\" par ma présence." }
                ]
            },
            {
                title: "2. Corps Physique",
                icon: "fa-leaf",
                color: "green",
                tooltip: "Manifestations énergétiques dans votre corps",
                items: [
                    { element: "fire", label: "Je suis épuisé après avoir \"combattu\" des énergies." },
                    { element: "water", label: "Je bâille beaucoup en présence de malades." },
                    { element: "earth", label: "Je sens l'énergie passer par mes jambes (lourdeur)." },
                    { element: "air", label: "Je sors souvent de mon corps (décorporation)." },
                    { element: "lightning", label: "Je ressens des picotements électriques constants." }
                ]
            },
            {
                title: "3. Corps Mental",
                icon: "fa-brain",
                color: "purple",
                tooltip: "Fonctionnement de votre mental et intuition",
                items: [
                    { element: "fire", label: "Je détecte IMMÉDIATEMENT le danger (Radar)." },
                    { element: "water", label: "Les gens me confient leurs secrets spontanément." },
                    { element: "earth", label: "Je porte des fardeaux psychologiques de ma lignée." },
                    { element: "air", label: "J'ai du mal à rester concentré sur le quotidien." },
                    { element: "lightning", label: "Mon esprit va trop vite, je suis en survoltage." }
                ]
            },
            {
                title: "4. Corps Spirituel",
                icon: "fa-star",
                color: "yellow",
                tooltip: "Votre mission d'âme et connexion spirituelle",
                items: [
                    { element: "fire", label: "Mission : Nettoyer les lieux et repousser l'ombre." },
                    { element: "water", label: "Mission : Transmuter la douleur émotionnelle." },
                    { element: "earth", label: "Mission : Guérir la terre et les lignées." },
                    { element: "air", label: "Mission : Lire les archives akashiques." },
                    { element: "lightning", label: "Mission : Créer des sauts quantiques." }
                ]
            }
        ];

        const ELEMENTS = [
            { key: 'fire', label: 'Feu', icon: 'fa-fire', color: 'red' },
            { key: 'water', label: 'Eau', icon: 'fa-droplet', color: 'blue' },
            { key: 'earth', label: 'Terre', icon: 'fa-mountain', color: 'green' },
            { key: 'air', label: 'Air', icon: 'fa-wind', color: 'purple' },
            { key: 'lightning', label: 'Foudre', icon: 'fa-bolt', color: 'yellow' }
        ];

        const DETAILS_CONFIG = [
            { key: 'emo', title: 'Corps Émotionnel', icon: 'fa-heart', color: 'blue' },
            { key: 'phy', title: 'Corps Physique', icon: 'fa-leaf', color: 'green' },
            { key: 'men', title: 'Corps Mental', icon: 'fa-brain', color: 'purple' },
            { key: 'spi', title: 'Corps Spirituel', icon: 'fa-star', color: 'yellow' }
        ];

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        class AppState {
            constructor() {
                this.data = {};
                this.unsaved = false;
                this.autoSaveTimeout = null;
            }

            setIdentity(identity) {
                this.data.identity = identity;
                this.scheduleAutoSave();
            }

            setResults(results) {
                this.data.results = results;
                this.unsaved = false;
                this.save();
            }

            save() {
                try {
                    localStorage.setItem(CONFIG.storageKey, JSON.stringify(this.data));
                    localStorage.setItem(CONFIG.timestampKey, new Date().toISOString());
                    this.showAutoSaveIndicator();
                    return true;
                } catch (e) {
                    console.error('Save error:', e);
                    return false;
                }
            }

            scheduleAutoSave() {
                clearTimeout(this.autoSaveTimeout);
                this.autoSaveTimeout = setTimeout(() => {
                    this.save();
                }, CONFIG.autoSaveDelay);
            }

            showAutoSaveIndicator() {
                const indicator = document.getElementById('auto-save-indicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            load() {
                try {
                    const saved = localStorage.getItem(CONFIG.storageKey);
                    if (saved) {
                        this.data = JSON.parse(saved);
                        return true;
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
                return false;
            }

            clear() {
                localStorage.removeItem(CONFIG.storageKey);
                localStorage.removeItem(CONFIG.timestampKey);
                this.data = {};
                this.unsaved = false;
            }

            getTimestamp() {
                return localStorage.getItem(CONFIG.timestampKey);
            }
        }

        const appState = new AppState();

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        const $ = id => document.getElementById(id);
        const $$ = (sel, ctx = document) => ctx.querySelectorAll(sel);

        const toast = (msg, type = 'info') => {
            const container = $('toast-container');
            const toastEl = document.createElement('div');
            toastEl.className = `toast ${type}`;
            const icons = { 
                success: 'fa-check-circle', 
                error: 'fa-exclamation-circle', 
                info: 'fa-info-circle' 
            };
            toastEl.innerHTML = `
                <i class="fa-solid ${icons[type]} text-lg" aria-hidden="true"></i>
                <span>${msg}</span>
            `;
            container.appendChild(toastEl);
            
            setTimeout(() => toastEl.classList.add('show'), 10);
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, 3000);
        };

        const validate = (input, errorEl) => {
            const value = input.value.trim();
            let isValid = true;
            let errorMsg = '';

            // Validation selon le type
            if (input.required && !value) {
                isValid = false;
                const labelText = input.labels && input.labels[0] 
                    ? input.labels[0].textContent.replace('*', '').trim()
                    : 'Ce champ';
                errorMsg = `${labelText} est requis`;
            } else if (input.type === 'date' && value) {
                const date = new Date(value);
                const now = new Date();
                if (isNaN(date.getTime())) {
                    isValid = false;
                    errorMsg = 'Date invalide';
                } else if (date > now) {
                    isValid = false;
                    errorMsg = 'La date doit être dans le passé';
                }
            }

            input.classList.toggle('error', !isValid);
            if (errorEl) {
                errorEl.textContent = errorMsg;
                errorEl.classList.toggle('show', !isValid);
            }
            
            return isValid;
        };

        const updateSteps = step => {
            [1, 2, 3].forEach(i => {
                const el = $(`step-indicator-${i}`);
                const circle = el.querySelector('.step-circle');
                
                el.classList.remove('active', 'completed');
                circle.removeAttribute('aria-current');
                
                if (i < step) {
                    el.classList.add('completed');
                } else if (i === step) {
                    el.classList.add('active');
                    circle.setAttribute('aria-current', 'step');
                }
            });
        };

        // ========================================
        // MÉTAPHYSIQUE & NUMÉROLOGIE
        // ========================================
        const getZodiac = dateStr => {
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) throw new Error('Invalid');
                
                const day = date.getDate();
                const month = date.getMonth() + 1;
                
                const signs = [
                    [[3, 21], [4, 19], "Bélier", "Feu"],
                    [[4, 20], [5, 20], "Taureau", "Terre"],
                    [[5, 21], [6, 20], "Gémeaux", "Air"],
                    [[6, 21], [7, 22], "Cancer", "Eau"],
                    [[7, 23], [8, 22], "Lion", "Feu"],
                    [[8, 23], [9, 22], "Vierge", "Terre"],
                    [[9, 23], [10, 22], "Balance", "Air"],
                    [[10, 23], [11, 21], "Scorpion", "Eau"],
                    [[11, 22], [12, 21], "Sagittaire", "Feu"],
                    [[12, 22], [1, 19], "Capricorne", "Terre"],
                    [[1, 20], [2, 18], "Verseau", "Air"],
                    [[2, 19], [3, 20], "Poissons", "Eau"]
                ];
                
                for (const [start, end, name, element] of signs) {
                    if ((month === start[0] && day >= start[1]) || (month === end[0] && day <= end[1])) {
                        return { n: name, e: element };
                    }
                }
                return { n: "?", e: "?" };
            } catch {
                return { n: "Erreur", e: "?" };
            }
        };

        const getLifePath = dateStr => {
            try {
                let sum = dateStr.replace(/-/g, '').split('').reduce((a, b) => a + parseInt(b), 0);
                const masters = [11, 22, 33];
                
                while (sum > 9 && !masters.includes(sum)) {
                    sum = String(sum).split('').reduce((a, b) => parseInt(a) + parseInt(b), 0);
                }
                
                return sum;
            } catch {
                return '?';
            }
        };

        const analyzeBirthProfile = (lifePath, birthDateStr) => {
            const date = new Date(birthDateStr);
            const day = date.getDate();
            const lpNum = parseInt(lifePath);
            
            const affinities = { fire: 0, water: 0, earth: 0, air: 0, lightning: 0 };

            // Règles Chemin de Vie
            if ([1, 8].includes(lpNum)) affinities.fire += 2;
            if ([2, 6, 9].includes(lpNum)) affinities.water += 2;
            if ([4, 7, 22].includes(lpNum)) affinities.earth += 2;
            if ([3, 7, 11, 33].includes(lpNum)) affinities.air += 2;
            if ([5, 11, 22, 33].includes(lpNum)) affinities.lightning += 2;

            // Règles Jour de Naissance
            if ([1, 10, 19, 28].includes(day)) affinities.fire += 1;
            if ([2, 6, 9, 11].includes(day)) affinities.water += 1;
            if ([4, 13, 16, 22].includes(day)) affinities.earth += 1;
            if ([3, 7, 11, 21].includes(day)) affinities.air += 1;
            if ([5, 14, 23].includes(day)) affinities.lightning += 1;

            // Trouver le dominant
            const maxScore = Math.max(...Object.values(affinities));
            const winners = Object.keys(affinities).filter(k => affinities[k] === maxScore);
            const priority = ['lightning', 'fire', 'water', 'earth', 'air'];
            const dominant = winners.length > 1 
                ? (priority.find(el => winners.includes(el)) || winners[0])
                : winners[0];

            return {
                dominant,
                lp: lpNum,
                day,
                details: NUMERO_DEFINITIONS[dominant]
            };
        };

        const isSaint = name => CONFIG.saints.some(s => name.toLowerCase().includes(s));

        // ========================================
        // QUIZ BUILDING
        // ========================================
        const buildQuiz = () => {
            const form = $('guide-form');
            form.innerHTML = QUESTIONS.map((section, sectionIndex) => `
                <fieldset class="slide-in" style="animation-delay: ${sectionIndex * 0.1}s">
                    <legend class="sr-only">${section.title}</legend>
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <span class="w-10 h-10 rounded-full bg-${section.color}-500/20 flex items-center justify-center text-${section.color}-400" aria-hidden="true">
                            <i class="fa-solid ${section.icon}"></i>
                        </span>
                        <h3 class="text-xl font-bold text-${section.color}-200">${section.title}</h3>
                        <div class="tooltip ml-auto">
                            <i class="fa-solid fa-question-circle text-slate-500 cursor-help" aria-hidden="true"></i>
                            <span class="tooltip-text">${section.tooltip}</span>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-1 gap-2">
                        ${section.items.map((item, itemIndex) => {
                            const labelText = item.label.replace(/<[^>]*>/g, '');
                            const id = `q-${sectionIndex}-${itemIndex}`;
                            return `
                                <label class="checkbox-wrapper" for="${id}">
                                    <input 
                                        type="checkbox" 
                                        id="${id}"
                                        name="${item.element}" 
                                        class="checkbox-input" 
                                        aria-label="${labelText}"
                                    >
                                    <div class="custom-checkbox">
                                        <div class="check-indicator" aria-hidden="true"></div>
                                        <span>${item.label}</span>
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                </fieldset>
            `).join('');

            // Event listeners
            $$('input[type="checkbox"]', form).forEach(cb => {
                cb.addEventListener('change', updateCounter);
            });
        };

        const updateCounter = () => {
            const count = $$('#guide-form input[type="checkbox"]:checked').length;
            $('question-counter').textContent = `${count} réponse${count > 1 ? 's' : ''} sélectionnée${count > 1 ? 's' : ''}`;
        };

        // ========================================
        // NAVIGATION
        // ========================================
        const startQuiz = e => {
            e.preventDefault();
            
            const prenomInput = $('prenom');
            const naissanceInput = $('naissance');
            const prenomError = $('error-prenom');
            const naissanceError = $('error-naissance');
            
            if (!prenomInput || !naissanceInput || !prenomError || !naissanceError) {
                console.error('Éléments de formulaire manquants');
                toast('Erreur de chargement du formulaire', 'error');
                return;
            }
            
            const prenomValid = validate(prenomInput, prenomError);
            const naissanceValid = validate(naissanceInput, naissanceError);
            
            if (!prenomValid || !naissanceValid) {
                toast('Veuillez corriger les erreurs', 'error');
                return;
            }
            
            appState.setIdentity({
                prenom: prenomInput.value.trim(),
                nom: $('nom').value.trim(),
                naissance: naissanceInput.value,
                lieu: $('lieu').value.trim()
            });
            
            appState.unsaved = true;
            $('step-identity').classList.add('hidden');
            $('step-quiz').classList.remove('hidden');
            updateSteps(2);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            toast('Analyse démarrée !', 'info');
        };

        const goBack = () => {
            if (appState.unsaved && !confirm('Vos réponses seront perdues. Continuer ?')) {
                return;
            }
            
            $('step-quiz').classList.add('hidden');
            $('step-identity').classList.remove('hidden');
            updateSteps(1);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        const loadSession = () => {
            const timestamp = appState.getTimestamp();
            
            if (!timestamp) {
                toast('Aucune session sauvegardée', 'info');
                return;
            }
            
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('fr-FR');
            const timeStr = date.toLocaleTimeString('fr-FR');
            
            if (confirm(`Session du ${dateStr} à ${timeStr}. Reprendre ?`)) {
                if (appState.load() && appState.data.identity) {
                    $('prenom').value = appState.data.identity.prenom || '';
                    $('nom').value = appState.data.identity.nom || '';
                    $('naissance').value = appState.data.identity.naissance || '';
                    $('lieu').value = appState.data.identity.lieu || '';
                    toast('Session restaurée !', 'success');
                } else {
                    toast('Erreur de chargement', 'error');
                }
            }
        };

        // ========================================
        // CALCULATION
        // ========================================
        const calculate = () => {
            const checked = $$('#guide-form input[type="checkbox"]:checked');
            
            if (!checked.length) {
                toast('Répondez au moins à une question', 'error');
                return;
            }
            
            if (checked.length < CONFIG.minAnswers) {
                if (!confirm('Peu de réponses. Le résultat sera moins précis. Continuer ?')) {
                    return;
                }
            }
            
            const btn = $('submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2" aria-hidden="true"></i>Analyse en cours...';
            
            setTimeout(() => {
                performCalculation(checked);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-chart-line mr-2" aria-hidden="true"></i>GÉNÉRER LE RAPPORT COMPLET';
            }, 1500);
        };

        const performCalculation = checked => {
            const scores = { fire: 0, water: 0, earth: 0, air: 0, lightning: 0 };
            checked.forEach(cb => scores[cb.name]++);
            
            const total = checked.length;
            const percentages = {};
            Object.keys(scores).forEach(key => {
                percentages[key] = Math.round((scores[key] / total) * 100);
            });
            
            const maxScore = Math.max(...Object.values(scores));
            const winners = Object.keys(scores).filter(k => scores[k] === maxScore);
            const priority = ['lightning', 'fire', 'water', 'earth', 'air'];
            const dominant = winners.length > 1 
                ? (priority.find(el => winners.includes(el)) || winners[0])
                : winners[0];
            
            if (winners.length > 1) {
                toast(`Profil mixte. Dominante: ${PROFILES[dominant].title}`, 'info');
            }
            
            // Calculs métaphysiques
            const astrology = getZodiac(appState.data.identity.naissance);
            const numerology = getLifePath(appState.data.identity.naissance);
            const numerologyAnalysis = analyzeBirthProfile(numerology, appState.data.identity.naissance);
            const saintName = isSaint(appState.data.identity.prenom);
            
            appState.setResults({
                scores,
                percentages,
                dominant,
                astrology,
                numerology,
                numerologyAnalysis,
                isSaintName: saintName,
                totalAnswers: total,
                timestamp: new Date().toISOString()
            });
            
            displayResults(
                PROFILES[dominant],
                astrology,
                numerology,
                saintName,
                percentages,
                numerologyAnalysis
            );
        };

        // ========================================
        // DISPLAY RESULTS
        // ========================================
        const displayResults = (profile, astro, numero, saint, percentages, numAnalysis) => {
            // En-tête
            $('res-name-full').textContent = `${appState.data.identity.prenom} ${appState.data.identity.nom}`;
            
            const lieuText = appState.data.identity.lieu 
                ? `Né(e) à ${appState.data.identity.lieu} le ${new Date(appState.data.identity.naissance).toLocaleDateString('fr-FR')}`
                : `Né(e) le ${new Date(appState.data.identity.naissance).toLocaleDateString('fr-FR')}`;
            $('res-lieu').textContent = lieuText;
            
            $('res-astro').textContent = `${astro.n} (${astro.e})`;
            $('res-numero').textContent = numero;
            
            // Numérologie
            $('numero-text').textContent = numAnalysis.details.text;
            $('numero-guide-tag').textContent = `Mission de Naissance : ${numAnalysis.details.guide}`;
            
            // Saint
            if (saint) {
                $('saint-card').classList.remove('hidden');
                $('saint-name').textContent = appState.data.identity.prenom;
            }
            
            // Barres de progression
            setTimeout(() => {
                $('bars-container').innerHTML = ELEMENTS.map(el => `
                    <div>
                        <div class="flex justify-between text-xs text-slate-400 mb-2">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid ${el.icon} text-${el.color}-400" aria-hidden="true"></i>
                                ${el.label}
                            </span>
                            <span class="font-bold">${percentages[el.key]}%</span>
                        </div>
                        <div class="bar-container" role="progressbar" aria-valuenow="${percentages[el.key]}" aria-valuemin="0" aria-valuemax="100" aria-label="${el.label} : ${percentages[el.key]}%">
                            <div class="bar-fill bg-${el.key}" style="width: ${percentages[el.key]}%"></div>
                        </div>
                    </div>
                `).join('');
            }, 300);
            
            // Profil principal
            $('guide-title').textContent = profile.title;
            $('guide-desc').textContent = profile.desc;
            $('guide-power').textContent = profile.power;
            $('guide-warning').textContent = profile.warning;
            $('main-card').className = `glass p-8 rounded-3xl border-t-4 ${profile.color}`;
            
            // Détails par corps
            $('details-container').innerHTML = DETAILS_CONFIG.map(detail => `
                <div class="flex gap-4 p-4 bg-white/5 rounded-xl border-l-4 border-${detail.color}-400">
                    <div class="w-12 h-12 rounded-full bg-${detail.color}-500/20 text-${detail.color}-400 flex items-center justify-center shrink-0" aria-hidden="true">
                        <i class="fa-solid ${detail.icon}"></i>
                    </div>
                    <div>
                        <h4 class="text-${detail.color}-300 font-bold text-sm uppercase mb-1">${detail.title}</h4>
                        <p class="text-slate-300 text-sm leading-relaxed">${profile.details[detail.key]}</p>
                    </div>
                </div>
            `).join('');
            
            // Prescriptions
            $('pres-stone').textContent = profile.pres.stone;
            $('pres-oil').textContent = profile.pres.oil;
            $('pres-ritual').textContent = profile.pres.ritual;
            
            // Navigation
            $('step-quiz').classList.add('hidden');
            $('step-result').classList.remove('hidden');
            updateSteps(3);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            toast('Rapport généré !', 'success');
            appState.unsaved = false;
        };

        // ========================================
        // ACTIONS
        // ========================================
        const downloadJSON = () => {
            if (!appState.data.results) {
                toast('Aucun résultat à télécharger', 'error');
                return;
            }
            
            const filename = `bilan_guide_${(appState.data.identity.nom || 'user').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            const blob = new Blob([JSON.stringify(appState.data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            toast('Téléchargé !', 'success');
        };

        const shareResults = () => {
            if (!appState.data.results) {
                toast('Aucun résultat à partager', 'error');
                return;
            }
            
            const text = `Mon profil énergétique : ${PROFILES[appState.data.results.dominant].title}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Mon Bilan Énergétique',
                    text: text,
                    url: location.href
                })
                .then(() => toast('Partagé !', 'success'))
                .catch(() => copyToClipboard(text));
            } else {
                copyToClipboard(text);
            }
        };

        const copyToClipboard = text => {
            navigator.clipboard.writeText(text)
                .then(() => toast('Copié !', 'success'))
                .catch(() => toast('Erreur de partage', 'error'));
        };

        const resetApp = () => {
            if (confirm('Recommencer ? Toutes les données seront perdues.')) {
                appState.clear();
                location.reload();
            }
        };

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Build quiz
                buildQuiz();
                
                // Event listeners
                const identityForm = $('identity-form');
                const loadSessionBtn = $('load-session-btn');
                const backBtn = $('back-btn');
                const submitBtn = $('submit-btn');
                const printBtn = $('print-btn');
                const shareBtn = $('share-btn');
                const downloadBtn = $('download-btn');
                const resetBtn = $('reset-btn');
                
                if (identityForm) identityForm.addEventListener('submit', startQuiz);
                if (loadSessionBtn) loadSessionBtn.addEventListener('click', loadSession);
                if (backBtn) backBtn.addEventListener('click', goBack);
                if (submitBtn) submitBtn.addEventListener('click', calculate);
                if (printBtn) printBtn.addEventListener('click', () => window.print());
                if (shareBtn) shareBtn.addEventListener('click', shareResults);
                if (downloadBtn) downloadBtn.addEventListener('click', downloadJSON);
                if (resetBtn) resetBtn.addEventListener('click', resetApp);
                
                // Real-time validation
                ['prenom', 'naissance'].forEach(id => {
                    const input = $(id);
                    const error = $(`error-${id}`);
                    if (input && error) {
                        input.addEventListener('blur', () => validate(input, error));
                        input.addEventListener('input', () => {
                            if (input.classList.contains('error')) {
                                validate(input, error);
                            }
                        });
                    }
                });
                
                // Warn before leaving with unsaved changes
                window.addEventListener('beforeunload', e => {
                    if (appState.unsaved && !$('step-result').classList.contains('hidden')) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                
                console.log('%c✨ Guide des 4 Corps - Version Optimisée ✨', 'color: #3b82f6; font-size: 16px; font-weight: bold;');
                console.log('%cApplication initialisée avec succès', 'color: #10b981; font-size: 12px;');
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                toast('Erreur de chargement de l\'application', 'error');
            }
        });
    </script>
</body>
</html>
